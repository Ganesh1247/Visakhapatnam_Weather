<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoGlance | AI Weather & Air Quality</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Sora:wght@500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif'],
                        heading: ['Sora', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            900: '#0B1120',
                            800: '#162032',
                            700: '#1E293B',
                        },
                        light: {
                            50: '#F8FAFC',
                            100: '#F1F5F9',
                            200: '#E2E8F0',
                        },
                        brand: {
                            400: '#22d3ee',
                            500: '#06b6d4',
                            600: '#0891b2',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'blob': 'blob 7s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style type="text/tailwindcss">
        @layer utilities {
            .glass {
                @apply bg-white/10 backdrop-blur-xl border border-white/20 shadow-[0_8px_32px_0_rgba(31,38,135,0.37)];
            }
            .glass-panel {
                @apply bg-white/5 backdrop-blur-lg border border-white/10 shadow-2xl;
            }
            .glass-card {
                @apply bg-white/10 backdrop-blur-md border border-white/20 hover:bg-white/15 transition-all duration-300;
            }
            
            .text-glow {
                text-shadow: 0 0 20px rgba(56, 189, 248, 0.5);
            }

            .bg-mesh {
                background-color: #030712;
                background-image: 
                    radial-gradient(at 0% 0%, hsla(253,16%,17%,1) 0, transparent 50%), 
                    radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                    radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            }

            .animation-delay-2000 {
                animation-delay: 2s;
            }
            .animation-delay-4000 {
                animation-delay: 4s;
            }
        }

        /* ===== LIGHT MODE THEME ===== */
        html:not(.dark) .text-glow {
            text-shadow: 0 0 15px rgba(14, 165, 233, 0.2);
        }

        html:not(.dark) .bg-mesh {
            background-color: #e8eef5;
            background-image: 
                radial-gradient(at 0% 0%, hsla(210, 40%, 88%, 0.8) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(200, 60%, 85%, 0.6) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(230, 40%, 90%, 0.5) 0, transparent 50%);
        }

        html:not(.dark) .glass {
            background: rgba(255, 255, 255, 0.65);
            border-color: rgba(148, 163, 184, 0.2);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
        }

        html:not(.dark) .glass-panel {
            background: rgba(255, 255, 255, 0.55);
            border-color: rgba(148, 163, 184, 0.15);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        html:not(.dark) .glass-card {
            background: rgba(255, 255, 255, 0.6);
            border-color: rgba(148, 163, 184, 0.2);
        }

        html:not(.dark) .glass-card:hover {
            background: rgba(255, 255, 255, 0.75);
        }

        /* Light mode text colors */
        html:not(.dark) body {
            color: #1e293b;
        }

        html:not(.dark) nav {
            background: rgba(255, 255, 255, 0.7);
            border-color: rgba(148, 163, 184, 0.15);
        }

        /* Light mode blob adjustments */
        html:not(.dark) .fixed .bg-brand-500\/20 {
            opacity: 0.15;
        }
        html:not(.dark) .fixed .bg-purple-500\/20 {
            opacity: 0.1;
        }
        html:not(.dark) .fixed .bg-pink-500\/20 {
            opacity: 0.1;
        }
        
        body {
            transition: color 0.5s ease, background-color 0.5s ease;
        }

        /* ===== COMPREHENSIVE LIGHT MODE TEXT & ELEMENT FIXES ===== */

        /* All white text ‚Üí dark slate in light mode */
        html:not(.dark) .text-white {
            color: #0f172a !important;
        }
        html:not(.dark) .text-white\/90 {
            color: #1e293b !important;
        }
        html:not(.dark) .text-white\/80 {
            color: #334155 !important;
        }
        html:not(.dark) .text-white\/60 {
            color: #475569 !important;
        }
        html:not(.dark) .text-white\/50 {
            color: #64748b !important;
        }
        html:not(.dark) .text-white\/40 {
            color: #64748b !important;
        }
        html:not(.dark) .text-white\/30 {
            color: #94a3b8 !important;
        }
        html:not(.dark) .text-white\/20 {
            color: #94a3b8 !important;
        }
        html:not(.dark) .text-white\/10 {
            color: #cbd5e1 !important;
        }
        html:not(.dark) .text-slate-200 {
            color: #1e293b !important;
        }

        /* Nav bar in light mode */
        html:not(.dark) nav {
            background: rgba(255, 255, 255, 0.75) !important;
            border-color: rgba(148, 163, 184, 0.2) !important;
        }

        /* Buttons & controls with bg-white/5 ‚Üí visible in light mode */
        html:not(.dark) .bg-white\/5 {
            background-color: rgba(148, 163, 184, 0.1) !important;
        }
        html:not(.dark) .bg-white\/10 {
            background-color: rgba(148, 163, 184, 0.15) !important;
        }

        /* Borders */
        html:not(.dark) .border-white\/5 {
            border-color: rgba(148, 163, 184, 0.15) !important;
        }
        html:not(.dark) .border-white\/10 {
            border-color: rgba(148, 163, 184, 0.2) !important;
        }
        html:not(.dark) .border-white\/20 {
            border-color: rgba(148, 163, 184, 0.25) !important;
        }

        /* AQI ring background circle */
        html:not(.dark) circle[stroke="rgba(255,255,255,0.05)"] {
            stroke: rgba(15, 23, 42, 0.08) !important;
        }

        /* Footer */
        html:not(.dark) footer {
            background-color: #e2e8f0 !important;
            border-color: rgba(148, 163, 184, 0.2) !important;
        }

        /* Mobile menu */
        html:not(.dark) #mobile-menu {
            background: rgba(255, 255, 255, 0.95) !important;
            border-color: rgba(148, 163, 184, 0.2) !important;
        }

        /* Modals */
        html:not(.dark) .bg-\[\#0B1120\] {
            background-color: #f1f5f9 !important;
        }

        /* Dynamic background blurs in light mode */
        html:not(.dark) .bg-brand-500\/10,
        html:not(.dark) .bg-indigo-500\/10 {
            opacity: 0.3;
        }

        /* H1 brand text */
        html:not(.dark) h1.text-white {
            color: #0f172a !important;
        }
        html:not(.dark) h1.group-hover\:text-brand-400:hover {
            color: #0ea5e9 !important;
        }

        /* Modern Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            @apply bg-slate-400/20 rounded-full hover:bg-slate-400/40;
        }
    </style>
    <style>
        :root {
            --eg-bg: #06121e;
            --eg-bg-soft: #0b1d2e;
            --eg-cyan: #06b6d4;
            --eg-sky: #0ea5e9;
            --eg-amber: #f59e0b;
        }

        body {
            letter-spacing: 0.01em;
        }

        .bg-mesh {
            background:
                radial-gradient(85% 52% at 8% 0%, rgba(14, 165, 233, 0.25) 0%, transparent 52%),
                radial-gradient(55% 50% at 94% 2%, rgba(245, 158, 11, 0.22) 0%, transparent 60%),
                radial-gradient(45% 40% at 48% 100%, rgba(6, 182, 212, 0.18) 0%, transparent 58%),
                linear-gradient(145deg, #05101a 0%, #071425 55%, #0a1322 100%);
        }

        .glass-panel {
            box-shadow: 0 18px 50px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.03);
            position: relative;
            overflow: hidden;
        }

        .glass-card {
            border-color: rgba(103, 232, 249, 0.26);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            border-color: rgba(103, 232, 249, 0.45);
        }

        .glass-panel::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
            border: 1px solid rgba(103, 232, 249, 0.12);
            background: linear-gradient(135deg, rgba(103, 232, 249, 0.06), transparent 35%, rgba(245, 158, 11, 0.05));
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            padding: 1px;
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }

        .forecast-tile {
            position: relative;
            overflow: hidden;
            border-radius: 1.4rem;
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: linear-gradient(160deg, rgba(255, 255, 255, 0.09), rgba(255, 255, 255, 0.02));
            transition: transform 0.26s ease, border-color 0.26s ease, box-shadow 0.26s ease, background 0.26s ease;
        }

        .forecast-tile::before {
            content: "";
            position: absolute;
            inset: -40% -10% auto -10%;
            height: 55%;
            background: radial-gradient(circle at 50% 50%, rgba(34, 211, 238, 0.18), transparent 65%);
            pointer-events: none;
            transform: translateY(-18px);
            transition: opacity 0.24s ease, transform 0.24s ease;
            opacity: 0.65;
        }

        .forecast-tile:hover {
            transform: translateY(-5px);
            border-color: rgba(34, 211, 238, 0.5);
            box-shadow: 0 18px 32px rgba(8, 145, 178, 0.2);
            background: linear-gradient(160deg, rgba(34, 211, 238, 0.15), rgba(255, 255, 255, 0.04));
        }

        .forecast-tile.forecast-active {
            border-color: rgba(34, 211, 238, 0.7);
            box-shadow: 0 0 0 1px rgba(34, 211, 238, 0.45), 0 22px 38px rgba(8, 145, 178, 0.26);
            background: linear-gradient(160deg, rgba(34, 211, 238, 0.2), rgba(255, 255, 255, 0.06));
        }

        .forecast-tile:hover::before,
        .forecast-tile.forecast-active::before {
            opacity: 1;
            transform: translateY(0);
        }

        .forecast-tile .hourly-chip {
            opacity: 0;
            transform: translateY(4px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .forecast-tile:hover .hourly-chip,
        .forecast-tile.forecast-active .hourly-chip {
            opacity: 1;
            transform: translateY(0);
        }

        .forecast-metric {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 9px;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 0.35rem 0.5rem;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: rgba(255, 255, 255, 0.72);
        }

        .section-title-kicker {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: rgba(125, 211, 252, 0.92);
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid rgba(14, 165, 233, 0.2);
            border-radius: 999px;
            padding: 0.35rem 0.7rem;
        }

        #forecast-list {
            position: relative;
            isolation: isolate;
            padding: 0.75rem;
            border-radius: 2rem;
            background: linear-gradient(145deg, rgba(14, 165, 233, 0.06), rgba(245, 158, 11, 0.04));
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        html:not(.dark) #forecast-list {
            background: linear-gradient(145deg, rgba(14, 165, 233, 0.11), rgba(245, 158, 11, 0.07));
            border-color: rgba(148, 163, 184, 0.2);
        }

        #navbar {
            background: linear-gradient(to bottom, rgba(3, 10, 18, 0.9), rgba(3, 10, 18, 0.58));
            border-bottom-color: rgba(103, 232, 249, 0.14);
            transform: translateY(0);
        }

        #navbar.nav-scrolled {
            background: rgba(4, 14, 24, 0.92);
            border-bottom-color: rgba(103, 232, 249, 0.3);
            box-shadow: 0 12px 28px rgba(2, 8, 18, 0.38);
            backdrop-filter: blur(20px);
        }

        #nav-shell {
            transition: height 0.3s ease, padding 0.3s ease, transform 0.3s ease;
        }

        #navbar.nav-scrolled #nav-shell {
            height: 4rem;
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }

        #mobile-menu {
            background: linear-gradient(to bottom, rgba(3, 10, 18, 0.96), rgba(3, 10, 18, 0.93)) !important;
            border-top-color: rgba(103, 232, 249, 0.12) !important;
        }

        #btn-mc.bg-brand-500\/20,
        #btn-quantile.bg-brand-500\/20,
        #btn-conformal.bg-brand-500\/20 {
            box-shadow: 0 0 0 1px rgba(103, 232, 249, 0.35), 0 10px 22px rgba(6, 182, 212, 0.18);
        }

        .text-glow {
            text-shadow: 0 0 26px rgba(34, 211, 238, 0.36);
        }

        html:not(.dark) .bg-mesh {
            background:
                radial-gradient(72% 40% at 8% 0%, rgba(14, 165, 233, 0.18) 0%, transparent 54%),
                radial-gradient(38% 38% at 92% 4%, rgba(245, 158, 11, 0.14) 0%, transparent 56%),
                linear-gradient(155deg, #f5fbff 0%, #e9f2fb 55%, #f7fbff 100%);
        }

        html:not(.dark) #navbar {
            background: rgba(255, 255, 255, 0.84);
            border-bottom-color: rgba(148, 163, 184, 0.26);
        }

        html:not(.dark) #navbar.nav-scrolled {
            background: rgba(255, 255, 255, 0.95);
            border-bottom-color: rgba(14, 165, 233, 0.25);
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.12);
        }

        .reveal-init {
            opacity: 0;
            transform: translateY(14px);
            transition: opacity 0.55s ease, transform 0.55s ease;
        }

        .reveal-in {
            opacity: 1;
            transform: translateY(0);
        }

        .hourly-view-tab {
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.04);
            color: rgba(255, 255, 255, 0.55);
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            padding: 0.45rem 0.75rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease;
        }

        .hourly-view-tab.active {
            background: rgba(34, 211, 238, 0.18);
            border-color: rgba(34, 211, 238, 0.5);
            color: #67e8f9;
            box-shadow: 0 8px 20px rgba(6, 182, 212, 0.2);
        }

        .hourly-inline-chart {
            height: 220px;
        }

        @media (max-width: 768px) {
            main {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }

            .hourly-inline-chart {
                height: 200px;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .animate-blob,
            .animate-pulse,
            .animate-bounce {
                animation: none !important;
            }
        }
    </style>
</head>

<body
    class="bg-mesh font-sans antialiased text-slate-200 min-h-screen selection:bg-brand-500 selection:text-white transition-colors duration-500 flex flex-col overflow-x-hidden">

    <!-- Background Blobs -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
        <div
            class="absolute top-0 left-1/4 w-96 h-96 bg-brand-500/20 rounded-full mix-blend-screen filter blur-3xl opacity-30 animate-blob">
        </div>
        <div
            class="absolute top-0 right-1/4 w-96 h-96 bg-sky-500/20 rounded-full mix-blend-screen filter blur-3xl opacity-30 animate-blob animation-delay-2000">
        </div>
        <div
            class="absolute -bottom-32 left-1/3 w-96 h-96 bg-amber-400/20 rounded-full mix-blend-screen filter blur-3xl opacity-30 animate-blob animation-delay-4000">
        </div>
    </div>

    <!-- Premium Navigation -->
    <nav class="fixed top-0 w-full z-50 backdrop-blur-xl border-b border-white/5 transition-all duration-300"
        id="navbar">
        <div id="nav-shell" class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between relative z-50">
            <!-- Brand -->
            <div class="flex items-center gap-4 group cursor-pointer" onclick="location.reload()">
                <div class="relative">
                    <div
                        class="w-10 h-10 sm:w-12 sm:h-12 rounded-2xl bg-gradient-to-tr from-brand-400 to-sky-600 flex items-center justify-center shadow-lg shadow-brand-500/20 group-hover:rotate-12 transition-transform duration-500">
                        <i class="ri-leaf-line text-xl sm:text-2xl text-white"></i>
                    </div>
                </div>
                <div>
                    <h1
                        class="font-heading font-bold text-xl sm:text-2xl tracking-tighter text-white group-hover:text-brand-400 transition-colors">
                        EcoGlance</h1>
                </div>
            </div>

            <!-- Header Actions -->
            <div class="flex items-center gap-2 sm:gap-4">
                <!-- Desktop Controls -->
                <div class="hidden lg:flex items-center gap-4">
                    <div class="flex items-center bg-white/5 border border-white/10 rounded-2xl p-1 gap-1">
                        <button onclick="setMethod('mc_dropout')" id="btn-mc"
                            class="px-4 py-2 rounded-xl text-xs font-bold transition-all hover:bg-white/10 text-white/60">MC
                            Dropout</button>
                        <button onclick="setMethod('quantile')" id="btn-quantile"
                            class="px-4 py-2 rounded-xl text-xs font-bold transition-all hover:bg-white/10 text-white/60">Quantile</button>
                        <button onclick="setMethod('conformal')" id="btn-conformal"
                            class="px-4 py-2 rounded-xl text-xs font-bold transition-all hover:bg-white/10 text-white/60">Conformal</button>
                    </div>

                    <button onclick="fetchPrediction()"
                        class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 border border-white/10 text-white/60 hover:text-white transition-all">
                        <i class="ri-refresh-line text-lg"></i>
                    </button>
                    <button onclick="document.getElementById('stats-modal').classList.remove('hidden')"
                        class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 border border-white/10 text-white/60 hover:text-white transition-all">
                        <i class="ri-bar-chart-box-line text-lg"></i>
                    </button>

                    <div class="h-8 w-px bg-white/10 mx-2"></div>

                    <a href="/logout"
                        class="flex items-center gap-3 px-5 py-2.5 rounded-2xl bg-white/5 border border-white/10 text-sm font-bold text-white/80 hover:bg-white/10 hover:border-white/20 transition-all group">
                        <span>Sign Out</span>
                        <i
                            class="ri-logout-box-r-line group-hover:translate-x-1 transition-transform text-brand-400"></i>
                    </a>
                </div>

                <!-- Theme Toggle -->
                <button onclick="toggleTheme()"
                    class="w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 border border-white/10 text-white/60 hover:text-white transition-all">
                    <i class="ri-sun-line text-lg dark:hidden"></i>
                    <i class="ri-moon-line text-lg hidden dark:block"></i>
                </button>

                <!-- Mobile Menu Toggle -->
                <button onclick="toggleMobileMenu()"
                    class="lg:hidden w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 border border-white/10 text-white">
                    <i class="ri-menu-4-line text-2xl" id="menu-icon"></i>
                </button>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu"
            class="hidden lg:hidden border-t border-white/5 bg-[#030712]/95 backdrop-blur-2xl absolute top-full left-0 w-full opacity-0 translate-y-[-10px] transition-all duration-300 z-40">
            <div class="p-6 space-y-6">
                <!-- Sync Status Indicator -->
                <div class="flex items-center gap-3 px-4 py-2 bg-white/5 rounded-xl border border-white/10">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                    <span id="engine-status-text"
                        class="text-[9px] font-black text-white/40 uppercase tracking-[0.2em]">Engine:
                        Operational</span>
                </div>

                <div class="space-y-3">
                    <p class="text-[10px] font-black text-white/20 uppercase tracking-widest ml-1">Prediction Core</p>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setMethod('mc_dropout'); toggleMobileMenu()" id="btn-mc-mob"
                            class="py-3 rounded-xl bg-white/5 text-[10px] font-bold text-white/60 border border-white/5">MC
                            Dropout</button>
                        <button onclick="setMethod('quantile'); toggleMobileMenu()" id="btn-quantile-mob"
                            class="py-3 rounded-xl bg-white/5 text-[10px] font-bold text-white/60 border border-white/5">Quantile</button>
                        <button onclick="setMethod('conformal'); toggleMobileMenu()" id="btn-conformal-mob"
                            class="py-3 rounded-xl bg-white/5 text-[10px] font-bold text-white/60 border border-white/5">Conformal</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button onclick="fetchPrediction(); toggleMobileMenu()"
                        class="flex items-center justify-center gap-3 py-4 rounded-2xl bg-brand-500/10 border border-brand-500/20 text-brand-400 font-bold text-sm">
                        <i class="ri-refresh-line"></i> Sync Data
                    </button>
                    <button
                        onclick="document.getElementById('stats-modal').classList.remove('hidden'); toggleMobileMenu()"
                        class="flex items-center justify-center gap-3 py-4 rounded-2xl bg-white/5 border border-white/10 text-white font-bold text-sm">
                        <i class="ri-bar-chart-box-line"></i> Diagnostics
                    </button>
                </div>

                <a href="/logout"
                    class="flex items-center justify-center gap-3 py-4 rounded-2xl bg-red-500/10 border border-red-500/20 text-red-400 font-bold text-sm">
                    <i class="ri-logout-box-r-line"></i> Sign Out
                </a>
            </div>
        </div>
    </nav>

    <!-- Dynamic Background Elements -->
    <div class="fixed inset-0 pointer-events-none overflow-hidden -z-10">
        <div
            class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-brand-500/10 rounded-full blur-[120px] animate-pulse">
        </div>
        <div
            class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-amber-400/10 rounded-full blur-[120px] animation-delay-2000 animate-pulse">
        </div>
    </div>

    <!-- Main Content -->
    <main class="pt-32 pb-20 px-6 max-w-7xl mx-auto w-full flex-grow relative z-10">

        <!-- Top Hero Section (Unified Current Weather) -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-12">

            <!-- Hero Card: Current Weather -->
            <div class="lg:col-span-8 group">
                <div
                    class="glass-panel rounded-[40px] p-6 sm:p-10 h-full relative overflow-hidden transition-all duration-500 hover:border-white/20">
                    <div class="relative z-10 h-full flex flex-col justify-between">
                        <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                            <div>
                                <div class="flex items-center gap-3 mb-4 sm:mb-6">
                                    <span
                                        class="px-4 py-1.5 rounded-full bg-brand-500/20 text-brand-400 text-[10px] font-black uppercase tracking-widest border border-brand-500/30">Live
                                        Now</span>
                                    <span class="text-white/40 text-[11px] font-bold uppercase tracking-widest"
                                        id="current-date">--</span>
                                </div>
                                <div class="flex items-center gap-4 sm:gap-6">
                                    <h2 class="text-7xl sm:text-[120px] font-heading font-bold text-white leading-none tracking-tighter text-glow"
                                        id="temp-main">--¬∞</h2>
                                    <div class="space-y-1">
                                        <p class="text-xl sm:text-2xl font-bold text-white/90" id="weather-desc">--</p>
                                        <p class="text-xs sm:text-sm text-white/40 font-medium">Feels like <span
                                                id="feels-like" class="text-white/60">--¬∞</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="text-9xl sm:text-[160px] filter drop-shadow-[0_0_30px_rgba(255,255,255,0.2)] animate-pulse-slow transition-transform hover:scale-110 duration-700 mx-auto sm:mx-0"
                                id="weather-icon-main">
                                ‚òÄÔ∏è
                            </div>
                        </div>

                        <!-- Weather Detail Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4 mt-8 sm:mt-12">
                            <div class="glass-card rounded-3xl p-4 sm:p-5">
                                <p
                                    class="text-[9px] sm:text-[10px] font-black text-white/30 uppercase tracking-[0.2em] mb-3">
                                    Humidity
                                </p>
                                <div class="flex items-center gap-2 sm:gap-3">
                                    <div
                                        class="w-8 h-8 sm:w-10 sm:h-10 rounded-xl bg-blue-500/20 flex items-center justify-center text-blue-400">
                                        <i class="ri-drop-fill text-lg"></i>
                                    </div>
                                    <span class="text-lg sm:text-xl font-bold text-white/90"
                                        id="humidity-detail">--%</span>
                                </div>
                            </div>
                            <div class="glass-card rounded-3xl p-4 sm:p-5">
                                <p
                                    class="text-[9px] sm:text-[10px] font-black text-white/30 uppercase tracking-[0.2em] mb-3">
                                    Wind
                                    Speed</p>
                                <div class="flex items-center gap-2 sm:gap-3">
                                    <div
                                        class="w-8 h-8 sm:w-10 sm:h-10 rounded-xl bg-cyan-500/20 flex items-center justify-center text-cyan-400">
                                        <i class="ri-windy-line text-lg"></i>
                                    </div>
                                    <span class="text-lg sm:text-xl font-bold text-white/90" id="wind-detail">--</span>
                                </div>
                            </div>
                            <div class="glass-card rounded-3xl p-4 sm:p-5">
                                <p
                                    class="text-[9px] sm:text-[10px] font-black text-white/30 uppercase tracking-[0.2em] mb-3">
                                    Pressure
                                </p>
                                <div class="flex items-center gap-2 sm:gap-3">
                                    <div
                                        class="w-8 h-8 sm:w-10 sm:h-10 rounded-xl bg-cyan-500/20 flex items-center justify-center text-cyan-400">
                                        <i class="ri-speed-mini-line text-lg"></i>
                                    </div>
                                    <span class="text-lg sm:text-xl font-bold text-white/90">1012 <span
                                            class="text-[10px] opacity-40">hPa</span></span>
                                </div>
                            </div>
                            <div class="glass-card rounded-3xl p-4 sm:p-5">
                                <p
                                    class="text-[9px] sm:text-[10px] font-black text-white/30 uppercase tracking-[0.2em] mb-3">
                                    Rainfall</p>
                                <div class="flex items-center gap-2 sm:gap-3">
                                    <div
                                        class="w-8 h-8 sm:w-10 sm:h-10 rounded-xl bg-amber-500/20 flex items-center justify-center text-amber-400">
                                        <i class="ri-umbrella-line text-lg"></i>
                                    </div>
                                    <span class="text-lg sm:text-xl font-bold text-white/90" id="rain-detail">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AQI Summary Card -->
            <div class="lg:col-span-4 flex flex-col gap-6">
                <div
                    class="glass-panel rounded-[40px] p-8 flex-grow flex flex-col items-center justify-center text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-b from-brand-500/5 to-transparent opacity-50"></div>
                    <p class="text-[11px] font-black text-white/30 uppercase tracking-[0.3em] mb-8 relative z-10">Air
                        Quality Index</p>

                    <div class="relative w-44 h-44 mb-6 group cursor-help">
                        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.05)"
                                stroke-width="6" />
                            <circle id="aqi-ring" cx="50" cy="50" r="45" fill="none" stroke="url(#aqiGradient)"
                                stroke-width="8" stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round"
                                class="transition-all duration-1000 ease-out" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-5xl font-heading font-black text-white tracking-tighter"
                                id="pm25-large">--</span>
                            <span
                                class="text-[10px] font-bold text-white/30 uppercase tracking-widest mt-1">PM2.5</span>
                        </div>
                        <div
                            class="absolute -inset-4 bg-brand-500/10 rounded-full blur-2xl opacity-0 group-hover:opacity-100 transition-opacity">
                        </div>
                    </div>

                    <div class="px-6 py-2 rounded-2xl bg-white/5 border border-white/10 text-xs font-black uppercase tracking-[0.2em] text-white/60 mb-8"
                        id="aqi-status-badge">
                        Calibrating...
                    </div>

                    <div class="w-full mb-8">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[10px] font-black uppercase tracking-[0.2em] text-white/30">Severity</span>
                            <span id="aqi-severity-label"
                                class="text-[10px] font-black uppercase tracking-[0.2em] text-brand-400">--</span>
                        </div>
                        <div class="relative h-2 rounded-full overflow-hidden bg-white/10 border border-white/10">
                            <div class="absolute inset-0 bg-gradient-to-r from-green-500 via-yellow-400 via-orange-500 to-red-500">
                            </div>
                            <div id="aqi-severity-pointer"
                                class="absolute top-1/2 -translate-y-1/2 -ml-1.5 w-3 h-3 rounded-full bg-white border-2 border-slate-900 shadow-[0_0_10px_rgba(255,255,255,0.8)] transition-all duration-500"
                                style="left: 0%;"></div>
                        </div>
                        <div class="mt-2 flex justify-between text-[9px] font-bold uppercase tracking-wider text-white/30">
                            <span>Good</span>
                            <span>Moderate</span>
                            <span>Unhealthy</span>
                            <span>Hazardous</span>
                        </div>
                    </div>

                    <div class="w-full grid grid-cols-2 gap-4">
                        <div class="bg-white/5 rounded-2xl p-4 border border-white/5">
                            <p class="text-[10px] font-bold text-white/20 uppercase mb-1">PM10</p>
                            <p class="text-lg font-bold text-white/80" id="pm10-metric">--</p>
                        </div>
                        <div class="bg-white/5 rounded-2xl p-4 border border-white/5">
                            <p class="text-[10px] font-bold text-white/20 uppercase mb-1">SO‚ÇÇ</p>
                            <p class="text-lg font-bold text-white/80">12.5</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Middle Section: Visualizations & Forecast -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- Forecast Visuals -->
            <div class="lg:col-span-8 space-y-8">
                <!-- HOURLY FORECAST (CAROUSEL) -->
                <div id="hourly-section" class="glass-panel rounded-[40px] p-5 sm:p-8 relative group">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-10 h-10 rounded-2xl bg-orange-500/20 flex items-center justify-center text-orange-400">
                                <i class="ri-time-line text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-heading font-black text-lg text-white/90">Hourly Outlook</h3>
                                <p class="text-xs text-white/30 font-bold uppercase tracking-widest"
                                    id="hourly-subtitle">Select a day</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="hidden sm:flex items-center gap-2 mr-1">
                                <button id="hourly-view-cards" class="hourly-view-tab active"
                                    onclick="setHourlyView('cards')">Cards</button>
                                <button id="hourly-view-chart" class="hourly-view-tab"
                                    onclick="setHourlyView('chart')">Graph</button>
                            </div>
                            <div class="flex gap-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                            <button
                                onclick="document.getElementById('hourly-scroll').scrollBy({left: -200, behavior: 'smooth'})"
                                class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/60 hover:text-white transition">
                                <i class="ri-arrow-left-s-line"></i>
                            </button>
                            <button
                                onclick="document.getElementById('hourly-scroll').scrollBy({left: 200, behavior: 'smooth'})"
                                class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/60 hover:text-white transition">
                                <i class="ri-arrow-right-s-line"></i>
                            </button>
                            </div>
                        </div>
                    </div>

                    <div class="sm:hidden mb-4 flex items-center gap-2">
                        <button id="hourly-view-cards-mobile" class="hourly-view-tab active"
                            onclick="setHourlyView('cards')">Cards</button>
                        <button id="hourly-view-chart-mobile" class="hourly-view-tab"
                            onclick="setHourlyView('chart')">Graph</button>
                    </div>

                    <div id="hourly-scroll" class="flex overflow-x-auto gap-3 pb-2 scrollbar-hide snap-x mask-linear">
                        <!-- Placeholder State -->
                        <div class="min-w-full flex flex-col items-center justify-center py-8 text-white/35">
                            <i class="ri-cursor-line text-2xl mb-2"></i>
                            <span class="text-[10px] font-black uppercase tracking-widest">Click a forecast date to
                                load hourly</span>
                        </div>
                    </div>

                    <div id="hourly-inline-chart-wrap" class="hidden mt-3">
                        <div class="hourly-inline-chart rounded-2xl bg-white/5 border border-white/10 p-3 sm:p-4">
                            <canvas id="hourlyInlineChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Trend Chart -->
                <div class="glass-panel rounded-[40px] p-6 sm:p-8">
                    <div class="flex justify-between items-center mb-10">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-10 h-10 rounded-2xl bg-amber-500/20 flex items-center justify-center text-amber-400">
                                <i class="ri-pulse-line text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-heading font-black text-lg text-white/90">Predictive Analytics</h3>
                                <p class="text-xs text-white/30 font-bold uppercase tracking-widest">7-Day Temporal
                                    Trend</p>
                            </div>
                        </div>
                    </div>
                    <div class="h-64 sm:h-80 w-full">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>

                <!-- 7-Day Forecast Grid -->
                <div class="space-y-6">
                    <div class="flex items-center gap-4">
                        <div class="w-8 h-8 rounded-xl bg-white/5 flex items-center justify-center text-white/40">
                            <i class="ri-calendar-line"></i>
                        </div>
                        <div class="flex items-center gap-3 flex-wrap">
                            <h3 class="text-[11px] font-black text-white/40 uppercase tracking-[0.4em]">Extended Outlook
                            </h3>
                            <span class="section-title-kicker"><i class="ri-sparkling-line"></i> Tap A Day For Hourly Drilldown</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-3 sm:gap-4" id="forecast-list">
                        <!-- Items injected via JS -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Advisory -->
            <div class="lg:col-span-4">
                <div class="glass-panel rounded-[40px] p-8 h-full sticky top-32">
                    <div class="flex items-center gap-4 mb-10">
                        <div class="w-10 h-10 rounded-2xl bg-red-500/20 flex items-center justify-center text-red-400">
                            <i class="ri-heart-pulse-line text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-heading font-black text-lg text-white/90">Health Advisory</h3>
                            <p class="text-xs text-white/30 font-bold uppercase tracking-widest">AI Safety Engine</p>
                        </div>
                    </div>

                    <div class="space-y-8">
                        <div class="bg-white/5 rounded-3xl p-6 border border-white/5">
                            <div class="flex gap-4 items-start">
                                <div class="text-3xl" id="rec-icon">üõ°Ô∏è</div>
                                <div>
                                    <h4 class="text-sm font-black text-white/90 uppercase mb-2 tracking-wide"
                                        id="rec-title">Status Check</h4>
                                    <p class="text-xs text-white/40 leading-relaxed font-medium" id="rec-summary">Our
                                        models are currently analyzing data...</p>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <p class="text-[10px] font-black text-green-500/60 uppercase tracking-[0.3em] mb-4">
                                    Recommended Actions</p>
                                <ul class="space-y-3" id="rec-do">
                                    <li class="flex items-center gap-3">
                                        <div class="w-1.5 h-1.5 bg-green-500 rounded-full"></div>
                                        <span class="text-xs font-bold text-white/50">Computing...</span>
                                    </li>
                                </ul>
                            </div>

                            <div id="rec-avoid-section" class="hidden">
                                <p class="text-[10px] font-black text-red-500/60 uppercase tracking-[0.3em] mb-4">
                                    Precautions</p>
                                <ul class="space-y-3" id="rec-avoid">
                                </ul>
                            </div>

                            <!-- Activity Suitability Matrix -->
                            <div class="pt-6 border-t border-white/5">
                                <p class="text-[10px] font-black text-white/20 uppercase tracking-[0.3em] mb-4">Activity
                                    Suitability</p>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-white/5 rounded-2xl p-3 flex items-center justify-between group"
                                        id="act-run">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white/40 group-[.safe]:text-green-400 group-[.unsafe]:text-red-400 transition-colors">
                                                <i class="ri-run-line"></i>
                                            </div>
                                            <span
                                                class="text-[10px] font-bold text-white/60 uppercase tracking-wider">Running</span>
                                        </div>
                                        <div
                                            class="w-2 h-2 rounded-full bg-white/10 group-[.safe]:bg-green-500 group-[.unsafe]:bg-red-500 shadow-[0_0_10px_currentColor] transition-colors">
                                        </div>
                                    </div>
                                    <div class="bg-white/5 rounded-2xl p-3 flex items-center justify-between group"
                                        id="act-cycle">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white/40 group-[.safe]:text-green-400 group-[.unsafe]:text-red-400 transition-colors">
                                                <i class="ri-riding-line"></i>
                                            </div>
                                            <span
                                                class="text-[10px] font-bold text-white/60 uppercase tracking-wider">Cycling</span>
                                        </div>
                                        <div
                                            class="w-2 h-2 rounded-full bg-white/10 group-[.safe]:bg-green-500 group-[.unsafe]:bg-red-500 shadow-[0_0_10px_currentColor] transition-colors">
                                        </div>
                                    </div>
                                    <div class="bg-white/5 rounded-2xl p-3 flex items-center justify-between group"
                                        id="act-walk">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white/40 group-[.safe]:text-green-400 group-[.unsafe]:text-red-400 transition-colors">
                                                <i class="ri-walk-line"></i>
                                            </div>
                                            <span
                                                class="text-[10px] font-bold text-white/60 uppercase tracking-wider">Walking</span>
                                        </div>
                                        <div
                                            class="w-2 h-2 rounded-full bg-white/10 group-[.safe]:bg-green-500 group-[.unsafe]:bg-red-500 shadow-[0_0_10px_currentColor] transition-colors">
                                        </div>
                                    </div>
                                    <div class="bg-white/5 rounded-2xl p-3 flex items-center justify-between group"
                                        id="act-vent">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-white/40 group-[.safe]:text-green-400 group-[.unsafe]:text-red-400 transition-colors">
                                                <i class="ri-home-gear-line"></i>
                                            </div>
                                            <span
                                                class="text-[10px] font-bold text-white/60 uppercase tracking-wider">Ventilation</span>
                                        </div>
                                        <div
                                            class="w-2 h-2 rounded-full bg-white/10 group-[.safe]:bg-green-500 group-[.unsafe]:bg-red-500 shadow-[0_0_10px_currentColor] transition-colors">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- AI Confidence Meter -->
                            <div class="pt-6 border-t border-white/5">
                                <div class="flex justify-between items-end mb-2">
                                    <p class="text-[10px] font-black text-brand-500 uppercase tracking-[0.3em]">AI
                                        Confidence</p>
                                    <span class="text-xs font-black text-white/90" id="ai-conf-score">94%</span>
                                </div>
                                <div class="h-2 w-full bg-white/5 rounded-full overflow-hidden">
                                    <div id="ai-conf-bar"
                                        class="h-full bg-gradient-to-r from-brand-500 to-cyan-400 w-[94%] shadow-[0_0_15px_rgba(34,211,238,0.55)] transition-all duration-1000 ease-out">
                                    </div>
                                </div>
                                <p class="text-[9px] text-white/30 mt-2 font-medium leading-relaxed">
                                    Based on ensemble variance across LSTM, XGBoost, and Conformal Prediction models.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <defs>
            <linearGradient id="aqiGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#10b981" />
                <stop offset="50%" stop-color="#eab308" />
                <stop offset="100%" stop-color="#ef4444" />
            </linearGradient>
        </defs>

        <!-- How It Works Section -->
        <div class="mt-20 mb-8">
            <h3 class="text-2xl font-heading font-black text-center mb-12 text-white/90 uppercase tracking-widest">Model
                Intelligence</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- MC Dropout -->
                <div class="p-8 rounded-[32px] glass-panel border border-white/5">
                    <div
                        class="w-12 h-12 rounded-2xl bg-blue-500/10 flex items-center justify-center text-blue-500 mb-6">
                        <i class="ri-brain-line text-2xl"></i>
                    </div>
                    <h4 class="text-lg font-black mb-3 text-white">MC Dropout</h4>
                    <p class="text-xs text-white/40 leading-relaxed font-medium">
                        Stochastic inference that simulates multiple future scenarios by randomly sampling neural
                        connections.
                    </p>
                    <div
                        class="mt-6 text-[9px] font-black text-blue-500 uppercase tracking-widest bg-blue-500/5 py-1 px-3 rounded-full inline-block">
                        Temporal Precision</div>
                </div>

                <!-- Quantile -->
                <div class="p-8 rounded-[32px] glass-panel border border-white/5">
                    <div
                        class="w-12 h-12 rounded-2xl bg-cyan-500/10 flex items-center justify-center text-cyan-500 mb-6">
                        <i class="ri-bar-chart-grouped-line text-2xl"></i>
                    </div>
                    <h4 class="text-lg font-black mb-3 text-white">Quantile Reg</h4>
                    <p class="text-xs text-white/40 leading-relaxed font-medium">
                        Predicts full probability distributions, highlighting the 10th-90th percentile bounds for risk.
                    </p>
                    <div
                        class="mt-6 text-[9px] font-black text-cyan-500 uppercase tracking-widest bg-cyan-500/5 py-1 px-3 rounded-full inline-block">
                        Distribution Analysis</div>
                </div>

                <!-- Conformal -->
                <div class="p-8 rounded-[32px] glass-panel border border-white/5">
                    <div
                        class="w-12 h-12 rounded-2xl bg-orange-500/10 flex items-center justify-center text-orange-500 mb-6">
                        <i class="ri-shield-check-line text-2xl"></i>
                    </div>
                    <h4 class="text-lg font-black mb-3 text-white">Conformal</h4>
                    <p class="text-xs text-white/40 leading-relaxed font-medium">
                        Mathematical guarantee framework ensuring the true value lies within the predicted interval.
                    </p>
                    <div
                        class="mt-6 text-[9px] font-black text-orange-500 uppercase tracking-widest bg-orange-500/5 py-1 px-3 rounded-full inline-block">
                        Statistical Safety</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Updated Footer -->
    <footer class="border-t border-white/5 bg-[#030712] relative z-20">
        <div class="max-w-7xl mx-auto px-6 py-16">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-12 sm:gap-20">
                <!-- About -->
                <div class="space-y-6">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-gradient-to-tr from-brand-500 to-sky-600 flex items-center justify-center">
                            <i class="ri-leaf-line text-white"></i>
                        </div>
                        <span class="font-heading font-bold text-2xl text-white">EcoGlance</span>
                    </div>
                    <p class="text-xs text-white/30 leading-relaxed font-medium">
                        A next-generation atmospheric intelligence platform. We utilize hybrid deep learning
                        architectures to project environmental safety indices with scientific certainty.
                    </p>
                </div>

                <!-- Tech -->
                <div class="space-y-6">
                    <h4 class="text-[10px] font-black text-white/20 uppercase tracking-[0.3em]">Core Architecture</h4>
                    <div class="space-y-4">
                        <div class="flex items-center gap-4">
                            <div class="w-1.5 h-1.5 rounded-full bg-brand-500"></div>
                            <span class="text-xs font-bold text-white/60">LSTM Temporal Embeddings</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="w-1.5 h-1.5 rounded-full bg-cyan-500"></div>
                            <span class="text-xs font-bold text-white/60">XGBoost Residual Mapping</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                            <span class="text-xs font-bold text-white/60">Bayesian Uncertainty Quant</span>
                        </div>
                    </div>
                </div>

                <!-- Contact -->
                <div class="space-y-6">
                    <h4 class="text-[10px] font-black text-white/20 uppercase tracking-[0.3em]">Communication</h4>
                    <div class="space-y-3">
                        <p class="text-sm font-bold text-white/80">+91 8790627210</p>
                        <p class="text-sm font-bold text-brand-500">support@ecoglance.ai</p>
                    </div>
                    <div class="flex gap-4 pt-2">
                        <i
                            class="ri-github-line text-xl text-white/20 hover:text-white transition-colors cursor-pointer"></i>
                        <i
                            class="ri-twitter-x-line text-xl text-white/20 hover:text-white transition-colors cursor-pointer"></i>
                    </div>
                </div>
            </div>

            <div class="mt-20 pt-8 border-t border-white/5 text-center">
                <p class="text-[9px] font-black text-white/10 uppercase tracking-[0.5em]">&copy; 2026 VSV ARCHIVE PORTAL
                </p>
            </div>
        </div>
    </footer>

    <!-- Stats Modal -->
    <div id="stats-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity"
            onclick="document.getElementById('stats-modal').classList.add('hidden')"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div
                class="glass-panel rounded-[40px] w-full max-w-3xl transform transition-all shadow-2xl overflow-hidden flex flex-col max-h-[90vh] bg-[#0B1120] dark:bg-[#0B1120] bg-white text-slate-800 dark:text-white">
                <div class="p-8 border-b border-white/10 flex justify-between items-center bg-white/5">
                    <div>
                        <h3
                            class="text-xl font-heading font-black dark:text-white text-slate-900 uppercase tracking-tight">
                            Model
                            Diagnostics</h3>
                        <p
                            class="text-[9px] font-black dark:text-white/20 text-slate-500 uppercase tracking-widest mt-1">
                            Live Engine
                            Performance</p>
                    </div>
                    <button onclick="document.getElementById('stats-modal').classList.add('hidden')"
                        class="dark:text-white/20 text-slate-400 hover:text-red-500 transition">
                        <i class="ri-close-circle-line text-3xl"></i>
                    </button>
                </div>
                <div class="p-8 overflow-y-auto">
                    <div class="overflow-x-auto rounded-2xl border border-white/5 bg-black/5 dark:bg-black/20">
                        <table class="w-full text-sm text-left dark:text-white/60 text-slate-600">
                            <thead class="text-[10px] uppercase bg-white/5 dark:text-white/40 text-slate-500">
                                <tr>
                                    <th scope="col" class="px-6 py-4 font-black">Target Variable</th>
                                    <th scope="col" class="px-6 py-4 font-black">RMSE</th>
                                    <th scope="col" class="px-6 py-4 font-black">MAE</th>
                                    <th scope="col" class="px-6 py-4 font-black">R¬≤ Score</th>
                                </tr>
                            </thead>
                            <tbody id="stats-body" class="divide-y divide-white/5">
                                <tr>
                                    <td colspan="4"
                                        class="px-6 py-12 text-center text-[10px] font-black dark:text-white/10 text-slate-400 uppercase tracking-[0.3em]">
                                        Querying Core Metrics...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading"
        class="fixed inset-0 z-[200] bg-[#030712]/90 backdrop-blur-xl flex flex-col items-center justify-center transition-opacity"
        style="display: none;">
        <div class="relative">
            <div class="w-24 h-24 border-[6px] border-brand-500/10 border-t-brand-500 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="ri-rocket-2-line text-2xl text-brand-500 animate-pulse"></i>
            </div>
        </div>
        <div class="text-white font-heading font-black text-xl mt-8 tracking-tighter animate-pulse">Running AI Forecast
        </div>
        <p class="text-white/20 text-[10px] font-black uppercase tracking-[0.3em] mt-2">Connecting to Intelligence
            Engine</p>
    </div>


    <!-- Hourly Modal -->
    <div id="hourly-modal" class="fixed inset-0 z-[150] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity"
            onclick="document.getElementById('hourly-modal').classList.add('hidden')"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div
                class="glass-panel rounded-[40px] w-full max-w-4xl transform transition-all shadow-2xl overflow-hidden flex flex-col max-h-[90vh] bg-[#0B1120] dark:bg-[#0B1120] bg-white text-slate-800 dark:text-white">
                <div class="p-8 border-b border-white/10 flex justify-between items-center bg-white/5">
                    <div>
                        <h3 class="text-xl font-heading font-black dark:text-white text-slate-900 uppercase tracking-tight"
                            id="hourly-title">Hourly Forecast</h3>
                        <p
                            class="text-[9px] font-black dark:text-white/20 text-slate-500 uppercase tracking-widest mt-1">
                            High-Resolution
                            Temporal Data</p>
                    </div>
                    <button onclick="document.getElementById('hourly-modal').classList.add('hidden')"
                        class="dark:text-white/20 text-slate-400 hover:text-red-500 transition">
                        <i class="ri-close-circle-line text-3xl"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto">
                    <div class="p-8 h-80 min-h-[300px]">
                        <canvas id="hourlyChartCanvas"></canvas>
                    </div>

                    <!-- Hourly Data Table -->
                    <div class="px-8 pb-8">
                        <div class="overflow-x-auto rounded-2xl border border-white/5 bg-black/5 dark:bg-black/20">
                            <table class="w-full text-sm text-left dark:text-white/60 text-slate-600">
                                <thead class="text-[10px] uppercase bg-white/5 dark:text-white/40 text-slate-500">
                                    <tr>
                                        <th class="px-4 py-3 font-black">Time</th>
                                        <th class="px-4 py-3 font-black">Temp</th>
                                        <th class="px-4 py-3 font-black">Rain</th>
                                        <th class="px-4 py-3 font-black">Wind</th>
                                        <th class="px-4 py-3 font-black">Condition</th>
                                    </tr>
                                </thead>
                                <tbody id="hourly-table-body" class="divide-y divide-white/5">
                                    <!-- Data populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div
                    class="p-4 bg-white/5 text-center text-[10px] dark:text-white/30 text-slate-500 border-t border-white/5">
                    Data sourced from Open-Meteo High-Resolution 1hr API
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        let currentMethod = 'mc_dropout';
        let currentDataCache = null;
        let forecastChart = null;

        // --- THEME & UI ---
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const icon = document.getElementById('menu-icon');

            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                icon.className = 'ri-close-line text-2xl';
                setTimeout(() => {
                    menu.classList.add('opacity-100', 'translate-y-0');
                    menu.classList.remove('opacity-0', 'translate-y-[-10px]');
                }, 10);
            } else {
                menu.classList.add('opacity-0', 'translate-y-[-10px]');
                menu.classList.remove('opacity-100', 'translate-y-0');
                setTimeout(() => {
                    menu.classList.add('hidden');
                    icon.className = 'ri-menu-4-line text-2xl';
                }, 300);
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
            // Re-render charts with updated theme colors
            if (currentDataCache && currentDataCache.forecast) {
                initChart(currentDataCache.forecast);
            }
        }

        function setMethod(method) {
            currentMethod = method;
            hourlyFetchUnlocked = false;
            resetHourlyState();

            // Update UI buttons (Sync Desktop & Mobile)
            ['mc', 'quantile', 'conformal'].forEach(m => {
                const btns = document.querySelectorAll(`[id^="btn-${m}"]`);
                btns.forEach(btn => {
                    if (m === method.replace('_', '')) {
                        btn.classList.add('bg-white/10', 'text-white', 'border-white/20');
                        btn.classList.remove('text-white/60');
                    } else {
                        btn.classList.remove('bg-white/10', 'text-white', 'border-white/20');
                        btn.classList.add('text-white/60');
                    }
                });
            });

            fetchPrediction();
        }

        // --- CHART JS ---
        function initChart(forecastData) {
            if (!forecastData || forecastData.length === 0) return;
            currentDataCache = { forecast: forecastData };

            const ctxCheck = document.getElementById('forecastChart');
            if (!ctxCheck) return;

            const ctx = ctxCheck.getContext('2d');

            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? 'rgba(255, 255, 255, 0.4)' : 'rgba(15, 23, 42, 0.4)';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.03)' : 'rgba(15, 23, 42, 0.03)';
            const tooltipBg = isDark ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.95)';
            const tooltipText = isDark ? '#fff' : '#0f172a';

            const labels = forecastData.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' });
            });

            const tempData = forecastData.map(d => parseFloat(d.temp_avg) || 0);
            const pmData = forecastData.map(d => parseFloat(d.pm2_5) || 0);

            if (forecastChart) forecastChart.destroy();

            const gradientTemp = ctx.createLinearGradient(0, 0, 0, 400);
            gradientTemp.addColorStop(0, isDark ? 'rgba(56, 189, 248, 0.2)' : 'rgba(56, 189, 248, 0.3)');
            gradientTemp.addColorStop(1, isDark ? 'rgba(56, 189, 248, 0.0)' : 'rgba(56, 189, 248, 0.05)');

            const gradientPM = ctx.createLinearGradient(0, 0, 0, 400);
            gradientPM.addColorStop(0, isDark ? 'rgba(16, 185, 129, 0.2)' : 'rgba(16, 185, 129, 0.3)');
            gradientPM.addColorStop(1, isDark ? 'rgba(16, 185, 129, 0.0)' : 'rgba(16, 185, 129, 0.05)');

            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Temp (¬∞C)',
                            data: tempData,
                            borderColor: '#38bdf8',
                            backgroundColor: gradientTemp,
                            borderWidth: 4,
                            pointBackgroundColor: isDark ? '#030712' : '#fff',
                            pointBorderColor: '#38bdf8',
                            pointHoverRadius: 6,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'PM2.5',
                            data: pmData,
                            borderColor: '#10b981',
                            backgroundColor: gradientPM,
                            borderWidth: 4,
                            pointBackgroundColor: isDark ? '#030712' : '#fff',
                            pointBorderColor: '#10b981',
                            pointHoverRadius: 6,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                color: isDark ? 'rgba(255,255,255,0.7)' : 'rgba(15, 23, 42, 0.7)',
                                usePointStyle: true,
                                boxWidth: 6,
                                font: { family: 'Inter', size: 10, weight: 'bold' }
                            }
                        },
                        tooltip: {
                            backgroundColor: tooltipBg,
                            titleColor: tooltipText,
                            titleFont: { family: 'Outfit', size: 14, weight: 'bold' },
                            bodyColor: isDark ? 'rgba(255,255,255,0.8)' : 'rgba(15, 23, 42, 0.8)',
                            borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(15, 23, 42, 0.1)',
                            borderWidth: 1,
                            padding: 12,
                            cornerRadius: 12,
                            displayColors: false
                        }
                    },
                    scales: {
                        x: { grid: { display: false }, ticks: { color: textColor, font: { size: 10 } } },
                        y: { position: 'left', grid: { color: gridColor }, ticks: { color: textColor } },
                        y1: { position: 'right', grid: { display: false }, ticks: { color: '#10b981', font: { size: 10 } } }
                    }
                }
            });
        }

        // --- HELPERS ---
        function getWeatherIcon(rainfall, temp) {
            if (rainfall > 15) return "‚õàÔ∏è";
            if (rainfall > 5) return "üåßÔ∏è";
            if (rainfall > 0.5) return "üå¶Ô∏è";
            if (temp > 35) return "üî•";
            if (temp > 30) return "‚òÄÔ∏è";
            return "üå§Ô∏è";
        }


        function renderHourlyTable(data) {
            const tbody = document.getElementById('hourly-table-body');
            if (!tbody) return;

            tbody.innerHTML = data.map(row => `
                <tr class="hover:bg-white/5 transition-colors border-b border-white/5 last:border-0">
                    <td class="px-4 py-3 font-mono text-white/80 text-xs">${row.time}</td>
                    <td class="px-4 py-3 font-bold text-brand-400 text-xs">${row.temp}¬∞C</td>
                    <td class="px-4 py-3 text-indigo-300 text-xs">${row.rain} mm</td>
                    <td class="px-4 py-3 text-white/60 text-xs">${row.wind} km/h</td>
                    <td class="px-4 py-3 text-[9px] uppercase font-bold tracking-wider text-white/50">${row.condition}</td>
                </tr>
            `).join('');
        }


        function renderHourlyCarousel(data) {
            const container = document.getElementById('hourly-scroll');
            if (!container) return;

            container.innerHTML = data.map(row => {
                const icon = getWeatherIcon(row.rain, row.temp);
                return `
                    <div class="min-w-[108px] h-[150px] flex flex-col items-center justify-center gap-2 glass-card rounded-[24px] bg-white/5 snap-center hover:bg-white/10 transition-colors cursor-default border border-white/5">
                        <span class="text-[10px] font-black text-white/40 uppercase tracking-widest">${row.time}</span>
                        <span class="text-3xl my-1 drop-shadow-lg">${icon}</span>
                        <span class="text-lg font-black text-white/90">${Math.round(row.temp)}¬∞</span>
                        <div class="flex items-center gap-1 mt-1">
                            <i class="ri-drop-fill text-[8px] text-blue-400"></i>
                            <span class="text-[9px] font-bold text-blue-300 ml-1">${row.rain}mm</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function setHourlyView(mode) {
            const cards = document.getElementById('hourly-scroll');
            const chart = document.getElementById('hourly-inline-chart-wrap');
            if (!cards || !chart) return;
            const showCards = mode === 'cards';
            cards.classList.toggle('hidden', !showCards);
            chart.classList.toggle('hidden', showCards);

            const pairs = [
                ['hourly-view-cards', 'hourly-view-chart'],
                ['hourly-view-cards-mobile', 'hourly-view-chart-mobile']
            ];
            pairs.forEach(([cardsId, chartId]) => {
                const cardsBtn = document.getElementById(cardsId);
                const chartBtn = document.getElementById(chartId);
                if (cardsBtn) cardsBtn.classList.toggle('active', showCards);
                if (chartBtn) chartBtn.classList.toggle('active', !showCards);
            });
        }

        function resetHourlyState() {
            const subtitle = document.getElementById('hourly-subtitle');
            if (subtitle) subtitle.innerText = 'Select a forecast date to load timeline';

            const container = document.getElementById('hourly-scroll');
            if (container) {
                container.innerHTML = `
                    <div class="min-w-full flex flex-col items-center justify-center py-8 text-white/35">
                        <i class="ri-cursor-line text-2xl mb-2"></i>
                        <span class="text-[10px] font-black uppercase tracking-widest">Click a forecast date to load hourly</span>
                    </div>
                `;
            }

            if (hourlyChartInstance) {
                hourlyChartInstance.destroy();
                hourlyChartInstance = null;
            }

            setHourlyView('cards');
        }

        async function fetchHourly(dateStr) {
            if (!hourlyFetchUnlocked) return;
            // Update Subtitle
            const subtitle = document.getElementById('hourly-subtitle');
            if (subtitle) subtitle.innerText = `Timeline for ${new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}`;

            // Show Loading in Carousel
            const container = document.getElementById('hourly-scroll');
            if (container) {
                container.innerHTML = `
                    <div class="min-w-full flex flex-col items-center justify-center py-8 text-white/30">
                         <i class="ri-loader-4-line text-2xl animate-spin mb-2"></i>
                         <span class="text-[10px] font-black uppercase tracking-widest">Loading High-Res Data...</span>
                    </div>
                `;
            }

            try {
                const res = await fetch(`/hourly/${dateStr}`);
                if (!res.ok) throw new Error("Failed to fetch hourly");
                const data = await res.json();
                renderHourlyCarousel(data);
                renderHourlyChart(data);

                // Optional: Scroll to start
                if (container) container.scrollTo({ left: 0, behavior: 'smooth' });

            } catch (e) {
                console.error(e);
                if (container) container.innerHTML = '<div class="w-full text-center text-red-500 py-8 text-xs font-bold">Failed to load hourly data</div>';
            }
        }

        let hourlyChartInstance = null;
        let selectedForecastDate = null;
        let hourlyFetchUnlocked = false;
        function renderHourlyChart(data) {
            const canvas = document.getElementById('hourlyInlineChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (hourlyChartInstance) hourlyChartInstance.destroy();

            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? 'rgba(255, 255, 255, 0.7)' : 'rgba(15, 23, 42, 0.7)';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.05)' : 'rgba(15, 23, 42, 0.05)';
            const tooltipBg = isDark ? 'rgba(15, 23, 42, 0.95)' : 'rgba(255, 255, 255, 0.95)';
            const tooltipText = isDark ? '#fff' : '#0f172a';

            const labels = data.map(d => d.time);
            const temps = data.map(d => d.temp);
            const rains = data.map(d => d.rain);

            // Base colors
            const tempColor = '#38bdf8';
            const tempBg = isDark ? 'rgba(56, 189, 248, 0.1)' : 'rgba(56, 189, 248, 0.2)';
            const rainColor = '#818cf8';
            const rainBg = isDark ? 'rgba(129, 140, 248, 0.1)' : 'rgba(129, 140, 248, 0.2)';

            hourlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Temp (¬∞C)',
                            data: temps,
                            borderColor: tempColor,
                            backgroundColor: tempBg,
                            yAxisID: 'y',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Rain (mm)',
                            data: rains,
                            borderColor: rainColor,
                            backgroundColor: rainBg,
                            yAxisID: 'y1',
                            type: 'bar',
                            barThickness: 6,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            labels: { color: textColor, font: { family: 'Inter', size: 11 } }
                        },
                        tooltip: {
                            backgroundColor: tooltipBg,
                            titleColor: tooltipText,
                            bodyColor: tooltipText,
                            borderColor: gridColor,
                            borderWidth: 1,
                            padding: 10,
                            displayColors: true
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: textColor, font: { size: 10 } },
                            grid: { display: false }
                        },
                        y: {
                            position: 'left',
                            ticks: { color: tempColor, font: { size: 10 } },
                            grid: { color: gridColor },
                            title: { display: true, text: 'Temperature (¬∞C)', color: tempColor, font: { size: 10 } }
                        },
                        y1: {
                            position: 'right',
                            ticks: { color: rainColor, font: { size: 10 } },
                            grid: { display: false },
                            title: { display: true, text: 'Precipitation (mm)', color: rainColor, font: { size: 10 } },
                            min: 0
                        }
                    }
                }
            });
        }

        // Expose to global scope for onClick
        window.fetchHourly = fetchHourly;



        function getAQIColor(pm25) {
            const cls = { bg: 'rgba(16, 185, 129, 0.1)', text: '#10b981' };
            if (pm25 > 30) { cls.bg = 'rgba(234, 179, 8, 0.1)'; cls.text = '#eab308'; }
            if (pm25 > 60) { cls.bg = 'rgba(249, 115, 22, 0.1)'; cls.text = '#f97316'; }
            if (pm25 > 90) { cls.bg = 'rgba(239, 68, 68, 0.1)'; cls.text = '#ef4444'; }
            if (pm25 > 120) { cls.bg = 'rgba(153, 0, 76, 0.1)'; cls.text = '#99004c'; }
            return cls;
        }

        function getAQISeverity(pm25) {
            if (pm25 <= 30) return { label: 'Good', color: '#22c55e' };
            if (pm25 <= 60) return { label: 'Moderate', color: '#eab308' };
            if (pm25 <= 90) return { label: 'Unhealthy', color: '#f97316' };
            if (pm25 <= 120) return { label: 'Very Unhealthy', color: '#ef4444' };
            return { label: 'Hazardous', color: '#99004c' };
        }

        function updateAQISeverityUI(pm25) {
            const severityLabel = document.getElementById('aqi-severity-label');
            const severityPointer = document.getElementById('aqi-severity-pointer');
            if (!severityLabel || !severityPointer) return;

            const severity = getAQISeverity(pm25);
            const clamped = Math.max(0, Math.min(pm25, 150));
            const pointerLeft = (clamped / 150) * 100;

            severityLabel.textContent = severity.label;
            severityLabel.style.color = severity.color;
            severityPointer.style.left = `${pointerLeft}%`;
        }

        // --- FETCH LOGIC ---
        const LOADING_MSGS = [
            "Initializing Hybrid Engine...",
            "Connecting to NASA Satellite Link...",
            "Processing LSTM Sequence...",
            "Running XGBoost Refinement...",
            "Calibrating Sensors...",
            "Finalizing Prediction..."
        ];

        async function fetchPrediction(retryCount = 0) {
            hourlyFetchUnlocked = false;
            resetHourlyState();
            const loading = document.getElementById('loading');
            const loadingText = loading.querySelector('p') || document.createElement('p');
            if (!loading.querySelector('p')) {
                loadingText.className = "mt-4 text-brand-400 font-mono text-xs animate-pulse";
                loading.appendChild(loadingText);
            }

            loading.style.display = 'flex';

            let msgIdx = 0;
            const msgInterval = setInterval(() => {
                loadingText.textContent = LOADING_MSGS[msgIdx % LOADING_MSGS.length];
                msgIdx++;
            }, 800);

            if (retryCount > 0) {
                loadingText.textContent = `Connection unstable. Retrying (${retryCount}/2)...`;
            } else {
                loadingText.textContent = LOADING_MSGS[0];
            }

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s timeout

                const res = await fetch(`/predict?method=${currentMethod}`, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!res.ok) {
                    const text = await res.text();
                    let errData;
                    try { errData = JSON.parse(text); } catch (e) { errData = { error: 'Interface Synchronization Failure' }; }
                    throw new Error(errData.error || 'Interface Sync Failure');
                }

                const data = await res.json();
                if (!data || !data.data) throw new Error('Fragmented Data Packet');

                // Update Engine Status
                const statusBadge = document.getElementById('aqi-status-badge');
                const engineText = document.getElementById('engine-status-text');

                // Explicitly show Hybrid Model
                if (engineText) engineText.innerHTML = 'Engine: <span class="text-brand-400">Hybrid (LSTM + XGB)</span>';

                if (data.forecast[0].engine === 'Standard (Lighter)') {
                    if (engineText) engineText.textContent = 'Engine: Standard (Light)';
                    statusBadge.innerHTML = 'Standard Mode <i class="ri-skip-forward-line ml-1"></i>';
                    statusBadge.title = 'Neural engine skipped to save RAM. Certainty scores may be limited.';
                }

                // Update Hero Content
                const tempVal = Math.round(data.data.temp_avg);
                document.getElementById('temp-main').innerHTML = `${tempVal}<span class="text-6xl text-white/20">¬∞</span>`;
                document.getElementById('feels-like').textContent = tempVal + '¬∞';
                document.getElementById('humidity-detail').textContent = Math.round(data.data.humidity) + '%';
                document.getElementById('wind-detail').innerHTML = `${data.data.wind_speed.toFixed(1)} <span class="text-[10px] opacity-40">m/s</span>`;
                document.getElementById('rain-detail').innerHTML = `${data.data.rainfall.toFixed(1)} <span class="text-[10px] opacity-40">mm</span>`;

                const weatherIcon = getWeatherIcon(data.data.rainfall, data.data.temp_avg);
                document.getElementById('weather-icon-main').textContent = weatherIcon;

                // Condition description
                let condition = 'Clear Skies';
                if (data.data.rainfall > 5) condition = 'Heavy Rain';
                else if (data.data.rainfall > 0.5) condition = 'Showers';
                else if (data.data.cloud_cover > 50) condition = 'Overcast';
                document.getElementById('weather-desc').textContent = condition;

                // Current Date
                const dateObj = new Date(data.prediction_date);
                document.getElementById('current-date').textContent = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

                // AQI Logic
                const pm25 = parseFloat(data.data.pm2_5) || 0;
                document.getElementById('pm25-large').textContent = Math.round(pm25);
                document.getElementById('pm10-metric').innerHTML = `${Math.round(data.data.pm10)} <span class="text-[10px] opacity-40">¬µg/m¬≥</span>`;

                const aqiStatus = document.getElementById('aqi-status-badge');
                aqiStatus.textContent = data.aqi.status;
                const aqiColors = getAQIColor(pm25);
                aqiStatus.style.backgroundColor = aqiColors.bg;
                aqiStatus.style.color = aqiColors.text;
                aqiStatus.style.borderColor = aqiColors.text + '20';
                updateAQISeverityUI(pm25);

                // --- Activity Suitability Logic ---
                const setActivity = (id, safe) => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.classList.remove(safe ? 'unsafe' : 'safe');
                        el.classList.add(safe ? 'safe' : 'unsafe');
                    }
                };

                const rain = data.data.rainfall;
                const wind = data.data.wind_speed;

                // Running: Unsafe if PM2.5 > 50 or Rain > 2
                setActivity('act-run', pm25 <= 50 && rain <= 2);

                // Cycling: Unsafe if PM2.5 > 70 or Rain > 5 or Wind > 20
                setActivity('act-cycle', pm25 <= 70 && rain <= 5 && wind <= 20);

                // Walking: Unsafe if PM2.5 > 100 or Rain > 8
                setActivity('act-walk', pm25 <= 100 && rain <= 8);

                // Ventilation: Unsafe if PM2.5 > 30 (Outdoor air is worse)
                setActivity('act-vent', pm25 <= 35);

                // --- AI Confidence Simulation ---
                // Base confidence 98%, reduce by weather volatility
                let confidence = 98 - (wind / 5) - (rain / 2);
                if (pm25 > 100) confidence -= 5; // Harder to predict extreme pollution
                confidence = Math.max(82, Math.min(99, confidence)); // Clamp between 82% and 99%

                // Add some random jitter for "live" feel
                confidence += (Math.random() * 2 - 1);

                const confVal = Math.round(confidence);
                document.getElementById('ai-conf-score').innerText = confVal + '%';
                document.getElementById('ai-conf-bar').style.width = confVal + '%';


                // Gauge Update
                const ring = document.getElementById('aqi-ring');
                const circumference = 2 * Math.PI * 45;
                const progress = Math.min(pm25 / 100, 1);
                ring.style.strokeDashoffset = circumference * (1 - progress);

                // Recommendations
                if (data.aqi.recommendations) {
                    const rec = data.aqi.recommendations;
                    document.getElementById('rec-title').textContent = rec.title;
                    document.getElementById('rec-summary').textContent = rec.summary;
                    document.getElementById('rec-do').innerHTML = rec.do.slice(0, 3).map(x =>
                        `<li class="flex items-center gap-3">
                            <div class="w-1.5 h-1.5 bg-green-500 rounded-full"></div>
                            <span class="text-xs font-bold text-white/50">${x}</span>
                        </li>`).join('');

                    if (rec.avoid && rec.avoid.length) {
                        document.getElementById('rec-avoid-section').classList.remove('hidden');
                        document.getElementById('rec-avoid').innerHTML = rec.avoid.slice(0, 2).map(x =>
                            `<li class="flex items-center gap-3">
                                <div class="w-1.5 h-1.5 bg-red-500 rounded-full"></div>
                                <span class="text-xs font-bold text-white/50">${x}</span>
                            </li>`).join('');
                    } else {
                        document.getElementById('rec-avoid-section').classList.add('hidden');
                    }
                }

                // Chart & Forecast List
                initChart(data.forecast);
                renderForecastList(data.forecast);

                if (data.forecast && data.forecast.length > 0) {
                    const activeDate = selectedForecastDate && data.forecast.some((d) => d.date === selectedForecastDate)
                        ? selectedForecastDate
                        : data.forecast[0].date;
                    hourlyFetchUnlocked = false;
                    selectForecastDate(activeDate, false);
                    resetHourlyState();

                    const list = document.getElementById('forecast-list');
                    if (list) {
                        list.querySelectorAll('.forecast-cue').forEach((el) => el.remove());
                        const firstCard = list.firstElementChild;
                        if (firstCard) {
                            const cue = document.createElement('div');
                            cue.className = "forecast-cue absolute -top-2 -right-2 bg-brand-500 text-white text-[9px] font-bold px-2 py-1 rounded-full animate-bounce shadow-lg z-10";
                            cue.innerText = "Click for Hourly";
                            firstCard.appendChild(cue);
                            firstCard.classList.add('relative');
                        }
                    }
                }

            } catch (err) {
                console.error(err);

                // Retry Logic
                if (retryCount < 2) {
                    loadingText.textContent = `Connection unstable. Retrying (${retryCount + 1}/2)...`;
                    clearInterval(msgInterval);
                    setTimeout(() => fetchPrediction(retryCount + 1), 3000);
                    return;
                }

                if (err.name === 'AbortError') {
                    alert('Neural Synthesis Timeout: The engine is under heavy load or spinning up. Please try again in 10 seconds.');
                } else {
                    alert('Intelligence Engine Sync Error: ' + err.message);
                }
            } finally {
                clearInterval(msgInterval);
                loading.style.display = 'none';
            }
        }

        function selectForecastDate(dateStr, triggerFetch = false) {
            selectedForecastDate = dateStr;
            document.querySelectorAll('[data-forecast-date]').forEach((card) => {
                const isActive = card.dataset.forecastDate === dateStr;
                card.classList.toggle('forecast-active', isActive);
            });
            if (triggerFetch && hourlyFetchUnlocked) {
                const list = document.getElementById('forecast-list');
                if (list) list.querySelectorAll('.forecast-cue').forEach((el) => el.remove());
                fetchHourly(dateStr);
                const section = document.getElementById('hourly-section');
                if (section) section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function onForecastDateClick(dateStr) {
            hourlyFetchUnlocked = true;
            selectForecastDate(dateStr, true);
        }

        function renderForecastList(forecast) {
            const container = document.getElementById('forecast-list');
            if (!container) return;
            container.innerHTML = forecast.map((d, i) => {
                const date = new Date(d.date);
                const day = date.toLocaleDateString('en-US', { weekday: 'short' });
                const dayNum = date.toLocaleDateString('en-US', { day: '2-digit' });
                const month = date.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();
                const icon = getWeatherIcon(d.rainfall, d.temp_avg);
                const isActive = selectedForecastDate ? selectedForecastDate === d.date : i === 0;

                return `
                    <div data-forecast-date="${d.date}" onclick="onForecastDateClick('${d.date}')" class="forecast-tile p-4 flex flex-col items-center gap-3 group cursor-pointer ${isActive ? 'forecast-active' : ''}">
                        <div class="absolute inset-0 bg-brand-500/0 group-hover:bg-brand-500/5 transition-colors duration-300 pointer-events-none"></div>
                        
                        <div class="relative z-10 text-center">
                            <span class="text-[9px] font-black uppercase tracking-widest ${isActive ? 'text-brand-400' : 'text-white/30'}">${day}</span>
                            <div class="text-xl font-heading font-black text-white/90 leading-none">${dayNum}</div>
                            <div class="text-[8px] font-black tracking-[0.2em] text-white/35">${month}</div>
                        </div>
                        <span class="text-3xl group-hover:scale-125 transition-transform duration-500 relative z-10">${icon}</span>
                        
                        <div class="text-center relative z-10">
                            <span class="text-base font-black text-white/90">${Math.round(d.temp_avg)}¬∞</span>
                            <div class="h-1 w-1 bg-white/10 rounded-full mx-auto mt-1"></div>
                        </div>
                        
                        <span class="forecast-metric relative z-10"><i class="ri-leaf-line"></i>${Math.round(d.pm2_5)} PM2.5</span>
                        
                        <div class="hourly-chip mt-2">
                             <span class="text-[8px] font-bold text-brand-400 bg-brand-500/10 px-2 py-1 rounded-full">Hourly</span>
                        </div>
                    </div>
                `;
            }).join('');

            if (!selectedForecastDate || !forecast.some((d) => d.date === selectedForecastDate)) {
                selectedForecastDate = forecast[0]?.date || null;
            }
            if (selectedForecastDate) selectForecastDate(selectedForecastDate, false);
        }

        async function fetchStats() {
            try {
                const res = await fetch('/stats');
                const data = await res.json();
                const body = document.getElementById('stats-body');

                if (!data || data.length === 0) {
                    body.innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-white/30 font-black uppercase tracking-widest">No diagnostics available</td></tr>';
                    return;
                }

                body.innerHTML = data.map(m => `
                    <tr class="hover:bg-white/5 transition-colors border-b border-white/5 last:border-0">
                        <th class="px-6 py-4 font-black text-white/90 uppercase tracking-wide text-[10px]">${(m.target || 'N/A').replace('xgb_chain_', '').replace('.pkl', '')}</th>
                        <td class="px-6 py-4 font-mono text-brand-400 font-bold">${Number(m.rmse || 0).toFixed(3)}</td>
                        <td class="px-6 py-4 font-mono text-indigo-400 font-bold">${Number(m.mae || 0).toFixed(3)}</td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 rounded-lg bg-white/5 text-[10px] font-black font-mono tracking-tighter ${(m.r2 || 0) > 0.8 ? 'text-green-400' : 'text-yellow-400'}">
                                ${Number(m.r2 || 0).toFixed(3)}
                            </span>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
            }
        }

        // --- INTERACTIVITY ---
        function initScrollReveal() {
            const nodes = document.querySelectorAll('.glass-panel, .glass-card');
            if (!nodes.length) return;

            nodes.forEach((el, index) => {
                el.classList.add('reveal-init');
                el.style.transitionDelay = `${Math.min(index * 35, 280)}ms`;
            });

            const observer = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (!entry.isIntersecting) return;
                    entry.target.classList.add('reveal-in');
                    observer.unobserve(entry.target);
                });
            }, { threshold: 0.12 });

            nodes.forEach((el) => observer.observe(el));
        }

        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (event) => {
                const target = event.target;
                const inEditable = target && (
                    target.tagName === 'INPUT' ||
                    target.tagName === 'TEXTAREA' ||
                    target.isContentEditable
                );
                if (inEditable || event.ctrlKey || event.metaKey || event.altKey) return;

                const key = event.key.toLowerCase();
                if (key === 'r') {
                    event.preventDefault();
                    fetchPrediction();
                }
                if (key === 's') {
                    event.preventDefault();
                    document.getElementById('stats-modal')?.classList.remove('hidden');
                }
                if (key === 't') {
                    event.preventDefault();
                    toggleTheme();
                }
            });
        }

        // --- INIT ---
        function updateNavbarState() {
            const nav = document.getElementById('navbar');
            if (!nav) return;
            nav.classList.toggle('nav-scrolled', window.scrollY > 20);
        }

        let navTicking = false;
        window.addEventListener('scroll', () => {
            if (navTicking) return;
            navTicking = true;
            requestAnimationFrame(() => {
                updateNavbarState();
                navTicking = false;
            });
        }, { passive: true });

        // Load initially
        document.addEventListener('DOMContentLoaded', () => {
            updateNavbarState();
            initScrollReveal();
            initKeyboardShortcuts();
            setHourlyView('cards');
            setMethod('mc_dropout');
            fetchStats();
        });
    </script>
</body>

</html>
